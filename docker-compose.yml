services:
  # ======================
  # Postgres compartido
  # ======================
  db:
    image: postgres:15
    container_name: news_nlp_db
    restart: always
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: postgres
    ports:
      # Host 5433 -> contenedor 5432
      - "5433:5432"
    volumes:
      - news_nlp_db_data:/var/lib/postgresql/data
      - ./docker/postgres-init.sql:/docker-entrypoint-initdb.d/postgres-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ======================
  # API FastAPI
  # ======================
  api:
    build:
      context: .
      dockerfile: docker/app.Dockerfile
    container_name: news_nlp_api
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      - db
    ports:
      # Host 8000 -> contenedor 8000
      - "8000:8000"
    command: >
      uvicorn news_nlp.api.app:app
        --host 0.0.0.0
        --port 8000

  # ======================
  # MLflow server
  # ======================
  mlflow:
    build:
      context: .
      dockerfile: docker/app.Dockerfile
    container_name: news_nlp_mlflow
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      - db
    ports:
      # Host 5000 -> contenedor 5000
      - "5000:5000"
    volumes:
      - mlflow_artifacts:/mlflow/artifacts
    command: >
      mlflow server
        --backend-store-uri ${MLFLOW_BACKEND_STORE_URI}
        --artifacts-destination ${MLFLOW_ARTIFACT_ROOT}
        --host 0.0.0.0
        --port 5000

  # ======================
  # Airflow init (one-shot)
  # ======================
  airflow-init:
    image: apache/airflow:2.9.0-python3.10
    container_name: news_nlp_airflow_init
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - .env
    entrypoint: /bin/bash
    command: >
      -c "airflow db migrate &&
          airflow users create
            --username $$AIRFLOW_USER
            --password $$AIRFLOW_PASSWORD
            --firstname $$AIRFLOW_FIRSTNAME
            --lastname $$AIRFLOW_LASTNAME
            --role $$AIRFLOW_ROLE
            --email $$AIRFLOW_EMAIL"
    volumes:
      - ./airflow_dags:/opt/airflow/dags
    restart: "no"

  # ======================
  # Airflow webserver
  # ======================
  airflow-webserver:
    image: apache/airflow:2.9.0-python3.10
    container_name: news_nlp_airflow_webserver
    restart: unless-stopped
    env_file:
      - .env
    environment:
      _PIP_ADDITIONAL_REQUIREMENTS: ${_PIP_ADDITIONAL_REQUIREMENTS}
    depends_on:
      db:
        condition: service_healthy
      airflow-init:
        condition: service_completed_successfully
    ports:
      # Host 8082 -> contenedor 8080
      - "8082:8080"
    volumes:
      - ./airflow_dags:/opt/airflow/dags
      - airflow_logs:/opt/airflow/logs
    command: >
      airflow webserver

  # ======================
  # Airflow scheduler
  # ======================
  airflow-scheduler:
    image: apache/airflow:2.9.0-python3.10
    container_name: news_nlp_airflow_scheduler
    restart: unless-stopped
    env_file:
      - .env
    environment:
      _PIP_ADDITIONAL_REQUIREMENTS: ${_PIP_ADDITIONAL_REQUIREMENTS}
    depends_on:
      db:
        condition: service_healthy
      airflow-init:
        condition: service_completed_successfully
    volumes:
      - ./airflow_dags:/opt/airflow/dags
      - airflow_logs:/opt/airflow/logs
    command: >
      airflow scheduler

volumes:
  news_nlp_db_data:
  mlflow_artifacts:
  airflow_logs:
